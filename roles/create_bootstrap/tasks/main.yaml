---

- name: Load in variables from env.yaml
  tags: bootstrap
  include_vars: env.yaml

- name: check if bootstrap already exists
  tags: bootstrap
  community.libvirt.virt:
    name: bootstrap
    command: status
  register: bootstrap_check
  ignore_errors: yes

- name: print status of bootstrap
  tags: bootstrap
  debug: 
    var: bootstrap_check

- name: boot bootstrap
  tags: bootstrap
  command: |
    virt-install --name bootstrap
    --disk size=100 --ram 16000 --cpu host --vcpus 4 
    --os-type linux --os-variant rhel8.0 
    --network network=macvtap-net 
    --location /var/lib/libvirt/images,kernel=rhcos-live-kernel-s390x,initrd=rhcos-live-initramfs.s390x.img 
    --extra-args "rd.neednet=1 coreos.inst=yes coreos.inst.install_dev=vda coreos.live.rootfs_url=http://{{env_ip_bastion}}:8080/bin/rhcos-live-rootfs.s390x.img ip={{env_ip_bootstrap}}::{{env_default_gateway}}:{{env_netmask}}:bootstrap:enc1:none:1500 nameserver={{env_dns_nameserver}} coreos.inst.ignition_url=http://{{env_dns_nameserver}}:8080/ignition/bootstrap.ign" 
    --noautoconsole --wait=-1
  when: bootstrap_check.failed == true

- name: Pause 15 minutes for installation. Once you see the login prompt on the bootstrap's terminal. Press "ctrl+C" and then "C" on your localhost terminal where you are seeing this message.
  tags: bootstrap
  pause:
    minutes: 15
  when: bootstrap_check.failed == true