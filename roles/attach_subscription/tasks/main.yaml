---

- name: Register server with Red Hat
  tags: attach_subscription
  community.general.redhat_subscription:
    state: present
    username: "{{ env.redhat.username }}"
    password: "{{ env.redhat.password }}"
    auto_attach: true
  register: registration
  retries: 2
  delay: 30
  until: registration is not failed

- name: Ensure necessary repositories are enabled.
  tags: attach_subscription
  community.general.rhsm_repository:
    name: "{{ item }}"
  loop:
    - "rhel-{{ ansible_distribution_major_version }}-for-{{ ansible_architecture }}-baseos-rpms"
    - "rhel-{{ ansible_distribution_major_version }}-for-{{ ansible_architecture }}-appstream-rpms"