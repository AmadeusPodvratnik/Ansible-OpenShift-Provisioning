---

- hosts: localhost
  tags: localhost, prep
  connection: local
  become: false
  gather_facts: no
  vars_files:
    - env.yaml
  vars:
    - ssh_target_ip: "{{ env_ip_kvm_host }}"
  roles:
    - ansible_setup
    - ssh_key_gen
    - ssh_copy_id

- hosts: kvm_host
  tags: kvm_host,kvm_prep
  become: true
  vars_files:
    - env.yaml
  vars: # feel free to add more packages as needed
    - packages: [ 'libvirt-devel', 'libvirt-daemon-kvm', 'qemu-kvm', 'virt-manager', 'libvirt-daemon-config-network', 'libvirt-client', 'qemu-img', 'libvirt' ] 
  roles:
    - check_ssh
    - install_packages
    - set_selinux_permissive
    - enable_packages
    - macvtap
    - mount_rhel
    - create_bastion

- hosts: localhost
  tags: localhost,bastion
  connection: local
  become: false
  gather_facts: no
  vars: 
    - ssh_target_ip: "{{ env_ip_bastion }}"
  roles:
    - ssh_copy_id # to connect to bastion

- hosts: bastion
  tags: bastion
  become: true
  vars_files:
    - env.yaml
  vars: # feel free to add more packages as needed
    - packages: [ 'ansible', 'haproxy', 'httpd', 'mod_ssl', 'bind', 'bind-utils', 'openssh' ]
  roles:
    - check_ssh
    #- install_packages
    #- install_ansible
    - ssh-ocp-key-gen # SSH key for bastion to connect to nodes
    - set_selinux_permissive
    - set_firewall
    - dns
    - haproxy
    - httpd
    - get-ocp

- hosts: kvm_host
  tags: kvm_host,create_nodes
  become: true
  gather_facts: no
  roles:
    - prep_kvm_guests
    - create_bootstrap
    - create_control_nodes
    - create_compute_nodes

#- hosts: localhost
  #connection: local
  #become: false
  #gather_facts: yes
  #roles:
  #- ssh_config_jump

#- hosts: bastion
  #become: true
  #gather_facts: no
  #roles:
  #- wait_for_bootstrap

#- hosts: bastion
  #tags: bastion,cluster
  #become: true
  #gather_facts: no
  #roles:
    #- connect_cluster

#- hosts: bastion
  #become: true
  #gather_facts: no
  #roles:
  #- wait_for_bootkube