---

#Copy SSH key to access bastion
- hosts: workstation
  connection: local
  become: false
  gather_facts: false
  vars_files: 
    - ../env.yaml
  vars: 
    ssh_target: ["{{ env.bastion.networking.ip }}","{{ env.bastion.access.user }}","{{ env.bastion.access.pass }}"]
  roles:
    - ssh_copy_id

#Configure bastion node with essential services
- hosts: bastion
  become: true
  vars:
    packages: "{{ env.pkgs.bastion }}"
  vars_files: 
    - ../env.yaml
  roles:
    - {role: attach_subscription, when: env.redhat.username is defined and env.redhat.password is defined}
    - install_packages
    - ssh_ocp_key_gen
    - set_firewall
    - {role: dns, when: env.bastion.options.dns }
    - check_dns
    - { role: haproxy, when: env.bastion.options.loadbalancer.on_bastion }
    - httpd
    - {role: get_ocp, become: false }